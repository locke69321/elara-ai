version: "3.9"

services:
  api:
    image: python:3.13-slim
    working_dir: /app
    command: >
      sh -c "pip install uv &&
             uv sync --all-groups &&
             PYTHONPATH=. uv run uvicorn apps.api.main:app --host 0.0.0.0 --port 8000"
    environment:
      ELARA_SQLITE_SECURE_MODE: "0"
      SQLITE_DATABASE_URL: "/data/elara.db"
      SQLITE_CIPHER_KEY: "change-me-in-prod"
    ports:
      - "8000:8000"
    volumes:
      - ..:/app
      - elara_data:/data

  web:
    image: node:22-alpine
    working_dir: /app
    command: >
      sh -c "corepack enable &&
             pnpm install &&
             pnpm --filter elara-web test"
    volumes:
      - ..:/app

volumes:
  elara_data:
